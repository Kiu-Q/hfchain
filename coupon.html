<!DOCTYPE html>
<head></head>
<body>
<div style="width: 500px" id="reader"></div>
<script src="html5-qrcode.min.js"></script>
<script type="module">
  import { getDatabase, ref, child, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCxqopzTrDNfFDS1e_Jpr5fnL0nmJn1Wvw",
    authDomain: "hf-chain.firebaseapp.com",
    databaseURL: "https://hf-chain-default-rtdb.firebaseio.com",
    projectId: "hf-chain",
    storageBucket: "hf-chain.appspot.com",
    messagingSenderId: "897232334716",
    appId: "1:897232334716:web:45b611f79c4caca1387ef9",
    measurementId: "G-CXV715K427"
  };
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const database = getDatabase(app);
  const dbRef = ref(getDatabase());
  var alert;
  /**/
var shop;
if (localStorage.getItem("shop") == null){
shop = window.prompt("Enter which shop your are:");
localStorage.setItem("shop",shop);
}else{
  shop = localStorage.getItem("shop");
}
function onScanSuccess(decodedText, decodedResult) {
console.log(`Scan result: ${decodedText}`, decodedResult);
const use = document.createElement('button');

use.innerText = 'Use this coupon';
get(child(dbRef,`coupon/${decodedText}/issueshop`)).then((snapshot) => {
  if (snapshot.exists()) {
    const cShop = snapshot.val();
    console.log(snapshot.val());
  } else {
    console.log("No data available");
  }
}).catch((error) => {
  console.error(error);
});
if (shop == cShop){
  alert = document.createElement("p");
  alert.innerText("Cannot use coupon issue at same shop");
  use.style.visibility = "hidden";
}
get(child(dbRef,`coupon/${decodedText}/ststus`)).then((snapshot) => {
  if (snapshot.exists()) {
    const cStatus = snapshot.val()
    console.log(snapshot.val());
  } else {
    console.log("No data available");
  }
}).catch((error) => {
  console.error(error);
});
if (cStatus == "invalid"){
  alert = document.createElement("p");
  alert.innerText("This coupon is in valid");
  use.style.visibility = "hidden";
};
function useC(){
  const db = getDatabase();
  set(ref(db, `coupon/${decodedText}/status`), "invalid");
};
use.addEventListener("click",useC);

}
var html5QrcodeScanner = new Html5QrcodeScanner(
"reader", { fps: 10, qrbox: 250 });
html5QrcodeScanner.render(onScanSuccess);

</script>
</body>